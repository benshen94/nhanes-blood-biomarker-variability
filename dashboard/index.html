<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NHANES Biomarker CV vs Age</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root {
      --bg: #f6f3eb;
      --card: #ffffff;
      --ink: #1f2937;
      --muted: #5f6b7a;
      --accent: #0f766e;
      --accent-soft: #c9ebe5;
      --warn: #b45309;
      --line: #ddd6c8;
      --chip: #f4efe5;
      --tab: #efe7d8;
      --tab-active: #0f766e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Georgia, 'Times New Roman', serif;
      color: var(--ink);
      background: radial-gradient(circle at 8% 10%, #fff9e8, var(--bg));
    }
    .wrap { max-width: 1320px; margin: 0 auto; padding: 20px; }
    .hero {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 16px;
      margin-bottom: 14px;
    }
    h1 { margin: 0; font-size: 34px; letter-spacing: 0.2px; }
    .sub { color: var(--muted); margin-top: 6px; }
    .status-chip {
      background: var(--chip);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }
    .top-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    .tab-btn {
      border: 1px solid var(--line);
      background: var(--tab);
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    .tab-btn.active {
      background: var(--tab-active);
      border-color: var(--tab-active);
      color: #fff;
    }
    .panel { display: none; }
    .panel.active { display: block; }

    .grid { display: grid; grid-template-columns: 330px 1fr; gap: 16px; }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }
    .sticky { position: sticky; top: 12px; }

    input[type="text"],
    input[type="search"],
    input[type="number"],
    input[type="range"],
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--line);
      border-radius: 8px;
      font-size: 14px;
      margin: 6px 0 10px 0;
      background: #fff;
    }
    label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    input[type="checkbox"] {
      width: auto;
      margin: 0;
      accent-color: var(--accent);
    }
    input[type="range"] {
      padding: 0;
      border: 0;
      margin: 8px 0 2px 0;
      accent-color: var(--accent);
      background: transparent;
    }
    .trim-caption {
      font-size: 12px;
      color: var(--muted);
      margin: 2px 0 10px 0;
    }
    .check-label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0 10px 0;
    }
    .mode-buttons { display: flex; gap: 8px; margin-bottom: 10px; }
    .mode-btn {
      border: 1px solid var(--line);
      background: #f8f5ef;
      border-radius: 8px;
      padding: 7px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    .mode-btn.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    #plot { width: 100%; height: 540px; }
    .metric { font-size: 14px; margin: 6px 0; }
    .flag-true { color: var(--accent); font-weight: 700; }
    .flag-false { color: var(--warn); }

    .table-wrap {
      max-height: 320px;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 8px;
      margin-top: 10px;
    }
    table { border-collapse: collapse; width: 100%; font-size: 13px; }
    th, td { border-bottom: 1px solid #eee7da; padding: 6px; text-align: left; }
    th { position: sticky; top: 0; background: #fffaf0; z-index: 1; }

    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .info-card h3 { margin: 2px 0 8px 0; font-size: 18px; }
    .info-card p { margin: 0 0 8px 0; color: var(--muted); }
    .info-card ul { margin: 8px 0 0 18px; padding: 0; }
    .info-card li { margin: 6px 0; }
    .mono { font-family: Menlo, Monaco, 'Courier New', monospace; font-size: 12px; color: var(--muted); }
    .compare-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: end; margin-bottom: 10px; }
    .compare-controls label { text-transform: none; letter-spacing: 0; font-size: 13px; }
    .compare-controls select, .compare-controls input { margin: 4px 0 0 0; width: 220px; }
    #compare-plot { width: 100%; height: 640px; }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
      .sticky { position: static; }
      #plot { height: 430px; }
      .info-grid { grid-template-columns: 1fr; }
      .hero { flex-direction: column; align-items: flex-start; }
      .wrap { padding: 14px; }
      h1 { font-size: 28px; }
      .sub { font-size: 15px; }
      #compare-plot { height: 560px; }
    }
    @media (max-width: 760px) {
      .tab-btn {
        flex: 1 1 calc(50% - 8px);
        text-align: center;
      }
      .table-wrap {
        max-height: none;
        overflow-x: auto;
      }
      table { font-size: 12px; min-width: 560px; }
      #plot { height: 380px; }
      #compare-plot { height: 500px; }
      .compare-controls label { width: 100%; }
      .compare-controls select,
      .compare-controls input { width: 100%; }
    }
    @media (max-width: 520px) {
      .tab-btn { flex: 1 1 100%; }
      .mode-buttons { flex-wrap: wrap; }
      .mode-btn { flex: 1 1 calc(33.333% - 8px); }
      #plot { height: 340px; }
      #compare-plot { height: 440px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div>
        <h1>NHANES Blood Biomarker Variability</h1>
        <div class="sub">Explore cross-sectional aging trajectories across blood biomarkers.</div>
      </div>
      <div id="status-chip" class="status-chip">Loading metadata…</div>
    </div>

    <div class="top-tabs">
      <button id="tab-dashboard" class="tab-btn active" type="button">Dashboard</button>
      <button id="tab-compare" class="tab-btn" type="button">Compare Rankings</button>
      <button id="tab-info" class="tab-btn" type="button">Info & Methods</button>
    </div>

    <div id="panel-dashboard" class="panel active">
      <div class="grid">
        <div class="card sticky">
          <div class="mode-buttons">
            <button id="mode-cv" class="mode-btn active" type="button">Plot CV</button>
            <button id="mode-mean" class="mode-btn" type="button">Plot Median</button>
            <button id="mode-skew" class="mode-btn" type="button">Plot Skewness</button>
          </div>

          <label for="search">Search Biomarker</label>
          <input id="search" list="biomarker-options" placeholder="Type name, code, file..." />
          <datalist id="biomarker-options"></datalist>

          <label for="category-filter">Clinical Category</label>
          <select id="category-filter"></select>
          <label class="check-label"><input id="include-env" type="checkbox" /> Include environmental/toxicant assays</label>

          <label for="biomarker-select">Select Biomarker</label>
          <select id="biomarker-select"></select>

          <label for="cohort-filter">Sex Group</label>
          <select id="cohort-filter">
            <option value="pooled" selected>Pooled</option>
            <option value="female">Female</option>
            <option value="male">Male</option>
            <option value="both">Both (Female + Male)</option>
          </select>

          <label for="trim-slider">Symmetric Trim Per Tail (%)</label>
          <input id="trim-slider" type="range" min="0" max="25" step="5" value="0" />
          <div id="trim-label" class="trim-caption">Using all values (0-100)</div>

          <label class="check-label"><input id="show-low-n" type="checkbox" checked /> Show low-n bins (&lt;30)</label>

          <div id="metrics" class="card" style="margin-top:10px;"></div>
        </div>

        <div class="card">
          <div id="plot"></div>
          <h3 id="rank-title">Biomarkers Ranked by Most Negative Spearman Rho (CV vs age)</h3>
          <div class="table-wrap"><table id="rank-table"></table></div>
        </div>
      </div>
    </div>

    <div id="panel-compare" class="panel">
      <div class="card">
        <div class="compare-controls">
          <label>Sort
            <select id="compare-sort">
              <option value="negative" selected>Most Negative Spearman</option>
              <option value="positive">Most Positive Spearman</option>
              <option value="absolute">Largest Absolute Spearman</option>
            </select>
          </label>
          <label>Statistic
            <select id="compare-stat">
              <option value="cv" selected>CV vs age</option>
              <option value="mean">Mean vs age</option>
              <option value="skewness">Skewness vs age</option>
            </select>
          </label>
          <label>Category
            <select id="compare-category"></select>
          </label>
          <label class="check-label"><input id="compare-include-env" type="checkbox" /> Include environmental/toxicant</label>
          <label>Cohort
            <select id="compare-cohort">
              <option value="pooled" selected>Pooled</option>
              <option value="female">Female</option>
              <option value="male">Male</option>
              <option value="both">Both (Female + Male)</option>
            </select>
          </label>
          <label>Symmetric trim (% per tail)
            <input id="compare-trim-slider" type="range" min="0" max="25" step="5" value="0" />
            <div id="compare-trim-label" class="trim-caption">Using all values (0-100)</div>
          </label>
          <label>Top N
            <input id="compare-topn" type="number" min="10" max="200" step="5" value="40" />
          </label>
        </div>
        <div id="compare-plot"></div>
      </div>
    </div>

    <div id="panel-info" class="panel">
      <div class="info-grid">
        <div class="card info-card">
          <h3>What This Analysis Does</h3>
          <p>For each blood biomarker test, this dashboard pools all NHANES cycles/files into one trajectory.</p>
          <ul>
            <li>Population: adults age 20+.</li>
            <li>Primary filter: non-pathological (pregnancy + major disease exclusions).</li>
            <li>Age aggregation: 5-year bins with minimum n=30 for primary trend metrics.</li>
            <li>Main metric: CV = SD / |Mean| per age bin.</li>
            <li>Pooling is done by normalized test name (not by NHANES variable code).</li>
            <li>Compatible unit variants are converted and pooled; incompatible unit systems remain separate entries.</li>
          </ul>
        </div>

        <div class="card info-card">
          <h3>Healthy Filter</h3>
          <p>Participants are excluded when available fields indicate:</p>
          <ul>
            <li>Pregnancy (<span class="mono">RIDEXPRG==1</span>)</li>
            <li>Diagnosed diabetes (<span class="mono">DIQ010==1</span>)</li>
            <li>CVD history (<span class="mono">MCQ160b/c/d/e/f</span> or legacy uppercase equivalents)</li>
            <li>Cancer history (<span class="mono">MCQ220==1</span>)</li>
            <li>Weak/failing kidneys (<span class="mono">KIQ022==1</span>)</li>
          </ul>
        </div>

        <div class="card info-card">
          <h3>Plot Modes</h3>
          <ul>
            <li><b>Plot CV</b>: age-binned CV trend.</li>
            <li><b>Plot Median</b>: age-binned median with interquartile band (25th-75th percentile) and raw scatter sample.</li>
            <li><b>Plot Skewness</b>: age-binned skewness trend (shape/asymmetry of per-bin values).</li>
            <li>Sex view: pooled, female, male, or both on the same chart (female red, male blue).</li>
            <li>Optional robust mode uses configurable symmetric trimming within each age bin (for example 10-90, 20-80, 25-75) before computing summaries.</li>
            <li>Raw scatter is sampled for performance and readability.</li>
          </ul>
        </div>

        <div class="card info-card">
          <h3>Decline Criteria</h3>
          <p>A biomarker is flagged as declining variability when all conditions hold:</p>
          <ul>
            <li><span class="mono">n_bins &gt;= 5</span></li>
            <li><span class="mono">Spearman rho &lt; 0</span></li>
            <li><span class="mono">Spearman p &lt; 0.05</span></li>
            <li><span class="mono">linear_slope_cv_per_year &lt; 0</span></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    const DATA_BASE = './data';
    const DATA_VERSION = '1771410463';

    const selectEl = document.getElementById('biomarker-select');
    const searchEl = document.getElementById('search');
    const optionsEl = document.getElementById('biomarker-options');
    const showLowNEl = document.getElementById('show-low-n');
    const modeCvBtn = document.getElementById('mode-cv');
    const modeMeanBtn = document.getElementById('mode-mean');
    const modeSkewBtn = document.getElementById('mode-skew');
    const statusChip = document.getElementById('status-chip');

    const tabDashboardBtn = document.getElementById('tab-dashboard');
    const tabCompareBtn = document.getElementById('tab-compare');
    const tabInfoBtn = document.getElementById('tab-info');
    const panelDashboard = document.getElementById('panel-dashboard');
    const panelCompare = document.getElementById('panel-compare');
    const panelInfo = document.getElementById('panel-info');
    const compareSortEl = document.getElementById('compare-sort');
    const compareStatEl = document.getElementById('compare-stat');
    const compareTopNEl = document.getElementById('compare-topn');
    const categoryFilterEl = document.getElementById('category-filter');
    const includeEnvEl = document.getElementById('include-env');
    const compareCategoryEl = document.getElementById('compare-category');
    const compareIncludeEnvEl = document.getElementById('compare-include-env');
    const cohortFilterEl = document.getElementById('cohort-filter');
    const compareCohortEl = document.getElementById('compare-cohort');
    const trimSliderEl = document.getElementById('trim-slider');
    const trimLabelEl = document.getElementById('trim-label');
    const compareTrimSliderEl = document.getElementById('compare-trim-slider');
    const compareTrimLabelEl = document.getElementById('compare-trim-label');
    const rankTitleEl = document.getElementById('rank-title');

    const CATEGORY_PRIORITY = {
      'Routine - CBC': 1,
      'Routine - CMP': 2,
      'Cardiometabolic - Lipid': 3,
      'Cardiometabolic - Glycemic': 4,
      'Organ - Thyroid': 5,
      'Organ - Renal': 6,
      'Organ - Hepatic': 7,
      'Specialized - Coagulation': 8,
      'Specialized - Nutritional/Vitamin': 9,
      'Specialized - Inflammatory': 10,
      'Hormones/Reproductive': 11,
      'Infectious/Serology': 12,
      'Other Clinical': 13,
      'Environmental/Toxicant': 14,
    };

    const COHORT_COLORS = {
      pooled: '#0f766e',
      female: '#d1495b',
      male: '#2563eb',
    };

    const state = {
      metadata: [],
      metrics: [],
      seriesIndex: {},
      metricsById: new Map(),
      metadataById: new Map(),
      cache: new Map(),
      mode: 'cv',
      currentId: null,
    };

    function formatNum(v, d=4) {
      if (v === null || v === undefined || Number.isNaN(v)) return 'NA';
      return Number(v).toFixed(d);
    }

    function normalizeTrimPct(v) {
      const n = Number(v ?? 0);
      if (!Number.isFinite(n)) return 0;
      return Math.max(0, Math.min(25, Math.round(n / 5) * 5));
    }

    function trimPctToMode(pct) {
      const p = normalizeTrimPct(pct);
      if (p <= 0) return 'all';
      return `trim_${p}_${100 - p}`;
    }

    function trimModeToPct(mode) {
      if (!mode || mode === 'all') return 0;
      const m = String(mode).match(/^trim_(\d{1,2})_(\d{1,2})$/);
      if (!m) return 0;
      return normalizeTrimPct(Number(m[1]));
    }

    function trimLabelFromPct(pct) {
      const p = normalizeTrimPct(pct);
      if (p <= 0) return 'Using all values (0-100)';
      return `${p}% each tail kept out -> using ${p}-${100 - p} percentile band`;
    }

    function modeToStat(mode) {
      if (mode === 'mean') return 'mean';
      if (mode === 'skewness') return 'skewness';
      return 'cv';
    }

    function statLabel(statKey) {
      if (statKey === 'mean') return 'Mean';
      if (statKey === 'skewness') return 'Skewness';
      return 'CV';
    }

    function setTopTab(tabName) {
      const isDash = tabName === 'dashboard';
      const isCompare = tabName === 'compare';
      const isInfo = tabName === 'info';
      tabDashboardBtn.classList.toggle('active', isDash);
      tabCompareBtn.classList.toggle('active', isCompare);
      tabInfoBtn.classList.toggle('active', isInfo);
      panelDashboard.classList.toggle('active', isDash);
      panelCompare.classList.toggle('active', isCompare);
      panelInfo.classList.toggle('active', isInfo);
    }

    async function fetchJson(path) {
      const sep = path.includes('?') ? '&' : '?';
      const r = await fetch(`${path}${sep}v=${DATA_VERSION}`, { cache: 'no-store' });
      if (!r.ok) throw new Error(`Failed to fetch ${path}: ${r.status}`);
      return await r.json();
    }

    async function loadSeries(biomarkerId) {
      if (state.cache.has(biomarkerId)) return state.cache.get(biomarkerId);
      const rel = state.seriesIndex[biomarkerId];
      if (!rel) return null;
      statusChip.textContent = `Loading series… ${biomarkerId}`;
      const series = await fetchJson(`${DATA_BASE}/${rel}`);
      state.cache.set(biomarkerId, series);
      statusChip.textContent = `Loaded ${state.cache.size} series in local cache`;
      return series;
    }

    function sortedCategories(metadata, includeEnv) {
      const cats = new Set();
      for (const m of metadata) {
        if (!includeEnv && m.is_environmental) continue;
        cats.add(m.category || 'Other Clinical');
      }
      return Array.from(cats).sort((a, b) => (CATEGORY_PRIORITY[a] ?? 999) - (CATEGORY_PRIORITY[b] ?? 999) || a.localeCompare(b));
    }

    function renderCategorySelect(selectNode, includeEnv, selectedValue) {
      const cats = sortedCategories(state.metadata, includeEnv);
      const options = [
        { value: 'all_core', label: 'Clinical/core tests first' },
        { value: 'all_non_env', label: 'All non-environmental blood tests' },
        { value: 'all', label: 'All visible categories' },
        ...cats.map(c => ({ value: `cat:${c}`, label: c })),
      ];
      selectNode.innerHTML = '';
      for (const opt of options) {
        const el = document.createElement('option');
        el.value = opt.value;
        el.textContent = opt.label;
        selectNode.appendChild(el);
      }
      const keep = options.some(o => o.value === selectedValue) ? selectedValue : 'all_core';
      selectNode.value = keep;
    }

    function metadataPasses(m, categoryValue, includeEnv) {
      const isEnv = Boolean(m.is_environmental);
      const isCore = Boolean(m.is_core_clinical);
      const cat = m.category || 'Other Clinical';
      if (!includeEnv && isEnv) return false;
      if (categoryValue === 'all_core') return isCore && !isEnv;
      if (categoryValue === 'all_non_env') return !isEnv;
      if (categoryValue === 'all') return includeEnv ? true : !isEnv;
      if (String(categoryValue || '').startsWith('cat:')) return cat === categoryValue.slice(4);
      return includeEnv ? true : !isEnv;
    }

    function getDashboardMetadata() {
      return state.metadata.filter(m => metadataPasses(m, categoryFilterEl.value, includeEnvEl.checked));
    }

    function getCompareMetrics() {
      const byId = state.metadataById;
      return state.metrics
        .map(m => {
          const md = byId.get(m.biomarker_id) || {};
          return {
            ...m,
            display_name: md.display_name || m.biomarker_name || m.biomarker_id,
            category: md.category || 'Other Clinical',
            is_environmental: Boolean(md.is_environmental),
            is_core_clinical: Boolean(md.is_core_clinical),
            trends: m.trends || {},
            sex_metrics_by_mode: m.sex_metrics || {},
            trends_by_stat: m.trends_by_stat || {
              cv: m.trends || {},
              mean: m.mean_trends || {},
              skewness: m.skewness_trends || {},
            },
            sex_metrics_by_stat: m.sex_metrics_by_stat || {
              cv: m.sex_metrics || {},
              mean: m.sex_mean_metrics || {},
              skewness: m.sex_skewness_metrics || {},
            },
          };
        })
        .filter(m => metadataPasses(m, compareCategoryEl.value, compareIncludeEnvEl.checked));
    }

    function renderOptions() {
      const opts = getDashboardMetadata().slice().sort(
        (a, b) => String(a.display_name || a.biomarker_name || '').localeCompare(String(b.display_name || b.biomarker_name || ''))
      );
      const previousId = state.currentId || selectEl.value;
      selectEl.innerHTML = '';
      optionsEl.innerHTML = '';
      for (const o of opts) {
        const label = `${o.display_name || o.biomarker_name}`;
        const opt = document.createElement('option');
        opt.value = o.biomarker_id;
        opt.textContent = label;
        selectEl.appendChild(opt);

        const dopt = document.createElement('option');
        dopt.value = label;
        optionsEl.appendChild(dopt);
      }
      if (opts.length === 0) {
        state.currentId = null;
        return null;
      }
      const next = opts.some(o => o.biomarker_id === previousId) ? previousId : opts[0].biomarker_id;
      selectEl.value = next;
      state.currentId = next;
      return next;
    }

    function renderMetricRows(title, m, rawTotal, rawCap, statKey) {
      if (!m) return `<div class="metric"><b>${title}:</b> no metrics</div>`;
      const isNegative = Boolean(m.negative_flag ?? m.decline_flag);
      const flagCls = isNegative ? 'flag-true' : 'flag-false';
      const stat = statLabel(statKey);
      return `
        <div class="metric"><b>${title} bins:</b> ${m.n_bins ?? 'NA'}</div>
        <div class="metric"><b>${title} Spearman rho (${stat} vs age):</b> ${formatNum(m.spearman_rho, 4)}</div>
        <div class="metric"><b>${title} Spearman p:</b> ${formatNum(m.spearman_p, 5)}</div>
        <div class="metric"><b>${title} Slope ${stat}/year:</b> ${formatNum(m.linear_slope_per_year ?? m.linear_slope_cv_per_year, 6)}</div>
        <div class="metric"><b>${title} Slope log(${stat})/year:</b> ${formatNum(m.linear_slope_log_per_year ?? m.linear_slope_logcv_per_year, 6)}</div>
        <div class="metric"><b>${title} Raw points:</b> up to ${rawCap ?? 'NA'} sampled of ${rawTotal ?? 'NA'} total</div>
        <div class="metric"><b>${title} Negative-trend flag:</b> <span class="${flagCls}">${isNegative}</span></div>
      `;
    }

    function renderMetrics(id, series=null) {
      const pooled = state.metricsById.get(id) || {};
      const md = state.metadataById.get(id) || {};
      const box = document.getElementById('metrics');
      if (!pooled || !Object.keys(pooled).length) {
        box.innerHTML = '<div class="metric">No metrics available.</div>';
        return;
      }

      const cohort = cohortFilterEl.value || 'pooled';
      const trimMode = trimPctToMode(trimSliderEl.value);
      const statKey = modeToStat(state.mode);
      const trendsByStat = pooled.trends_by_stat || {
        cv: pooled.trends || {},
        mean: pooled.mean_trends || {},
        skewness: pooled.skewness_trends || {},
      };
      const sexByStat = pooled.sex_metrics_by_stat || {
        cv: pooled.sex_metrics || {},
        mean: pooled.sex_mean_metrics || {},
        skewness: pooled.sex_skewness_metrics || {},
      };
      const trendByMode = trendsByStat[statKey] || {};
      const pooledMetric = trendByMode[trimMode] || trendByMode.all || null;
      const sexMetricsByMode = sexByStat[statKey] || {};
      const sexMetrics = sexMetricsByMode[trimMode] || sexMetricsByMode.all || {};
      const rawBySex = (series && series.raw_total_n_by_sex) ? series.raw_total_n_by_sex : {};
      const rawCap = md.raw_sample_cap ?? 'NA';
      const trimLabel = trimLabelFromPct(trimSliderEl.value);
      const stat = statLabel(statKey);

      let html = `<div class="metric"><b>Category:</b> ${md.category || 'Other Clinical'}</div>`;
      html += `<div class="metric"><b>Outlier mode:</b> ${trimLabel}</div>`;
      html += `<div class="metric"><b>Ranking/stat view:</b> ${stat} vs age</div>`;
      if (cohort === 'both') {
        html += renderMetricRows('Female', sexMetrics.female || null, rawBySex.female ?? 'NA', rawCap, statKey);
        html += renderMetricRows('Male', sexMetrics.male || null, rawBySex.male ?? 'NA', rawCap, statKey);
      } else if (cohort === 'female' || cohort === 'male') {
        const m = sexMetrics[cohort] || null;
        html += renderMetricRows(cohort === 'female' ? 'Female' : 'Male', m, rawBySex[cohort] ?? 'NA', rawCap, statKey);
      } else {
        html += renderMetricRows('Pooled', pooledMetric, md.raw_total_n ?? 'NA', rawCap, statKey);
      }
      box.innerHTML = html;
    }

    function setMode(mode) {
      state.mode = mode;
      modeCvBtn.classList.toggle('active', mode === 'cv');
      modeMeanBtn.classList.toggle('active', mode === 'mean');
      modeSkewBtn.classList.toggle('active', mode === 'skewness');
    }

    function pickPointsByCohort(s, cohort, trimMode) {
      const mode = trimMode || 'all';
      const byMode = s.points_by_filter || {};
      const sexByMode = s.sex_points_by_filter || {};
      if (cohort === 'female') return (sexByMode[mode] && sexByMode[mode].female) ? sexByMode[mode].female : [];
      if (cohort === 'male') return (sexByMode[mode] && sexByMode[mode].male) ? sexByMode[mode].male : [];
      if (byMode[mode]) return byMode[mode];
      return s.points || [];
    }

    function pickRawByCohort(s, cohort) {
      if (cohort === 'female') return (s.raw_sample_by_sex && s.raw_sample_by_sex.female) ? s.raw_sample_by_sex.female : [];
      if (cohort === 'male') return (s.raw_sample_by_sex && s.raw_sample_by_sex.male) ? s.raw_sample_by_sex.male : [];
      return s.raw_sample || [];
    }

    function lineTrace(points, color, label, valueField, hoverTextFn=null) {
      return {
        x: points.map(p => p.age_mid),
        y: points.map(p => p[valueField]),
        text: points.map(p => hoverTextFn ? hoverTextFn(p) : `age_bin=${p.age_bin}<br>n=${p.n}<br>mean=${formatNum(p.mean, 4)}<br>std=${formatNum(p.std, 4)}<br>cv=${formatNum(p.cv, 4)}<br>skewness=${formatNum(p.skewness, 4)}`),
        mode: 'lines+markers',
        type: 'scatter',
        marker: { size: points.map(p => p.passes_n_threshold ? 8 : 5), color },
        line: { color, width: 2 },
        hovertemplate: '%{text}<extra></extra>',
        name: label
      };
    }

    function ciBandTrace(points, color, label) {
      const ciPoints = points.filter(p => p.q25 !== null && p.q75 !== null);
      if (ciPoints.length < 2) return null;
      return {
        x: ciPoints.map(p => p.age_mid).concat(ciPoints.map(p => p.age_mid).reverse()),
        y: ciPoints.map(p => p.q75).concat(ciPoints.map(p => p.q25).reverse()),
        type: 'scatter',
        fill: 'toself',
        fillcolor: color,
        line: { color: 'rgba(0,0,0,0)' },
        hoverinfo: 'skip',
        name: label
      };
    }

    async function renderPlot(id) {
      const s = await loadSeries(id);
      if (!s) return;
      state.currentId = id;
      const showLow = showLowNEl.checked;
      const cohort = cohortFilterEl.value || 'pooled';
      const trimMode = trimPctToMode(trimSliderEl.value);

      const traces = [];
      const title = `${s.display_name || s.biomarker_name}`;
      const selectedCohorts = cohort === 'both' ? ['female', 'male'] : [cohort];
      const cohortLabel = { pooled: 'Pooled', female: 'Female', male: 'Male' };
      const band95 = {
        pooled: 'rgba(15,118,110,0.16)',
        female: 'rgba(209,73,91,0.18)',
        male: 'rgba(37,99,235,0.18)',
      };
      for (const c of selectedCohorts) {
        const pointsRaw = pickPointsByCohort(s, c, trimMode);
        let points = showLow ? pointsRaw : pointsRaw.filter(p => p.passes_n_threshold);
        if (!points || points.length === 0) continue;

        if (state.mode === 'cv') {
          points = points.filter(p => p.cv !== null && p.cv !== undefined && Number.isFinite(Number(p.cv)));
          if (points.length === 0) continue;
          traces.push(lineTrace(points, COHORT_COLORS[c], `${cohortLabel[c]} CV`, 'cv'));
          continue;
        }

        if (state.mode === 'skewness') {
          points = points.filter(p => p.skewness !== null && p.skewness !== undefined && Number.isFinite(Number(p.skewness)));
          if (points.length === 0) continue;
          traces.push(lineTrace(
            points,
            COHORT_COLORS[c],
            `${cohortLabel[c]} Skewness`,
            'skewness',
            (p) => `age_bin=${p.age_bin}<br>n=${p.n}<br>skewness=${formatNum(p.skewness, 4)}<br>median=${formatNum(p.median, 4)}<br>mean=${formatNum(p.mean, 4)}<br>cv=${formatNum(p.cv, 4)}`
          ));
          continue;
        }

        const ci = ciBandTrace(points, band95[c], `${cohortLabel[c]} IQR (25th-75th)`);
        if (ci) traces.push(ci);
        traces.push({
          ...lineTrace(
            points,
            COHORT_COLORS[c],
            `${cohortLabel[c]} Median (binned)`,
            'median',
            (p) => `age_bin=${p.age_bin}<br>n=${p.n}<br>median=${formatNum(p.median, 4)}<br>q25=${formatNum(p.q25, 4)}<br>q75=${formatNum(p.q75, 4)}<br>mean=${formatNum(p.mean, 4)}<br>std=${formatNum(p.std, 4)}<br>cv=${formatNum(p.cv, 4)}<br>skewness=${formatNum(p.skewness, 4)}`
          ),
        });

        const raw = pickRawByCohort(s, c);
        if (raw && raw.length > 0) {
          traces.push({
            x: raw.map(p => p.age_years),
            y: raw.map(p => p.value),
            mode: 'markers',
            type: 'scatter',
            marker: { color: c === 'female' ? 'rgba(209,73,91,0.23)' : c === 'male' ? 'rgba(37,99,235,0.23)' : 'rgba(71,85,105,0.25)', size: 4 },
            hovertemplate: 'age=%{x}<br>value=%{y:.4f}<extra>' + `${cohortLabel[c]} raw sample` + '</extra>',
            name: `${cohortLabel[c]} Raw sample`
          });
        }
      }

      renderMetrics(id, s);
      const mobile = window.matchMedia('(max-width: 760px)').matches;
      Plotly.newPlot('plot', traces, {
        title,
        xaxis: { title: 'Age (years)', tickfont: { size: mobile ? 10 : 12 } },
        yaxis: {
          title: state.mode === 'cv'
            ? 'Coefficient of Variation (CV)'
            : state.mode === 'skewness'
              ? 'Skewness (binned)'
              : 'Median Biomarker Value',
          tickfont: { size: mobile ? 10 : 12 }
        },
        margin: mobile ? { t: 52, l: 46, r: 10, b: 44 } : { t: 56, l: 64, r: 18, b: 54 },
        paper_bgcolor: '#ffffff',
        plot_bgcolor: '#ffffff',
        legend: {
          orientation: 'h',
          y: 1.08,
          font: { size: mobile ? 10 : 12 },
          itemwidth: mobile ? 38 : undefined
        }
      }, { responsive: true, displaylogo: false });
    }

    function metricsForView(rows, cohort, trimMode, statKey='cv') {
      const out = [];
      for (const rec of rows) {
        const trendsByStat = rec.trends_by_stat || { cv: rec.trends || {}, mean: {}, skewness: {} };
        const sexByStat = rec.sex_metrics_by_stat || { cv: rec.sex_metrics_by_mode || {}, mean: {}, skewness: {} };
        const trends = trendsByStat[statKey] || {};
        const sexByMode = sexByStat[statKey] || {};
        const tr = trends[trimMode] || trends.all || null;
        const sexTr = sexByMode[trimMode] || sexByMode.all || {};

        if (cohort === 'both') {
          const fm = sexTr.female || null;
          const ml = sexTr.male || null;
          if (!fm || !ml) continue;
          const rhoF = Number(fm.spearman_rho);
          const rhoM = Number(ml.spearman_rho);
          if (!Number.isFinite(rhoF) || !Number.isFinite(rhoM)) continue;
          out.push({
            ...rec,
            rho: (rhoF + rhoM) / 2,
            p: null,
            n_bins: Math.min(Number(fm.n_bins || 0), Number(ml.n_bins || 0)),
            decline_flag: Boolean((fm.negative_flag ?? fm.decline_flag) && (ml.negative_flag ?? ml.decline_flag)),
            female_metric: fm,
            male_metric: ml,
            rho_female: rhoF,
            rho_male: rhoM,
          });
          continue;
        }

        const m = cohort === 'female' || cohort === 'male' ? (sexTr[cohort] || null) : tr;
        if (!m) continue;
        const rho = Number(m.spearman_rho);
        if (!Number.isFinite(rho)) continue;
          out.push({
            ...rec,
            rho,
            p: m.spearman_p,
            n_bins: m.n_bins,
            decline_flag: Boolean(m.negative_flag ?? m.decline_flag),
            metric: m,
          });
        }
      return out;
    }

    function renderRankTable() {
      const tbl = document.getElementById('rank-table');
      const visible = new Set(getDashboardMetadata().map(m => m.biomarker_id));
      const cohort = cohortFilterEl.value || 'pooled';
      const trimMode = trimPctToMode(trimSliderEl.value);
      const statKey = modeToStat(state.mode);
      const stat = statLabel(statKey);
      if (rankTitleEl) rankTitleEl.textContent = `Biomarkers Ranked by Most Negative Spearman Rho (${stat} vs age)`;
      const ranked = metricsForView(
        getCompareMetrics().filter(r => visible.has(r.biomarker_id)),
        cohort,
        trimMode,
        statKey
      ).sort((a, b) => (a.rho ?? 999) - (b.rho ?? 999));
      const top = ranked.slice(0, 200);
      let html = `<thead><tr><th>Biomarker</th><th>Spearman rho (${stat})</th><th>p</th><th>Negative trend</th></tr></thead><tbody>`;
      for (const r of top) {
        html += `<tr data-id="${r.biomarker_id}"><td>${r.display_name}</td><td>${formatNum(r.rho, 4)}</td><td>${formatNum(r.p, 5)}</td><td>${r.decline_flag}</td></tr>`;
      }
      html += '</tbody>';
      tbl.innerHTML = html;

      for (const tr of tbl.querySelectorAll('tbody tr')) {
        tr.style.cursor = 'pointer';
        tr.onclick = async () => {
          const id = tr.getAttribute('data-id');
          selectEl.value = id;
          renderMetrics(id);
          await renderPlot(id);
        };
      }
    }

    function renderComparePlot() {
      const mode = compareSortEl.value;
      const statKey = compareStatEl.value || 'cv';
      const stat = statLabel(statKey);
      const cohort = compareCohortEl.value || 'pooled';
      const trimMode = trimPctToMode(compareTrimSliderEl.value);
      const topN = Math.max(10, Math.min(200, Number(compareTopNEl.value || 40)));
      const trimLabel = trimLabelFromPct(compareTrimSliderEl.value);
      compareTopNEl.value = String(topN);

      let ranked = metricsForView(getCompareMetrics(), cohort, trimMode, statKey).slice();
      const rankVal = (m) => (mode === 'absolute' ? Math.abs(m.rho) : m.rho);
      if (mode === 'negative') ranked.sort((a, b) => rankVal(a) - rankVal(b));
      if (mode === 'positive') ranked.sort((a, b) => rankVal(b) - rankVal(a));
      if (mode === 'absolute') ranked.sort((a, b) => rankVal(b) - rankVal(a));
      ranked = ranked.slice(0, topN);

      const y = ranked.map(r => r.display_name).reverse();
      const categoryLabel = compareCategoryEl.options[compareCategoryEl.selectedIndex]?.textContent || 'All';
      let traces = [];
      let xTitle = `Spearman rho (Age vs ${stat})`;

      if (cohort === 'both') {
        const xF = ranked.map(r => Number(r.rho_female)).reverse();
        const xM = ranked.map(r => Number(r.rho_male)).reverse();
        traces = [
          {
            type: 'bar',
            orientation: 'h',
            y,
            x: xF,
            marker: { color: COHORT_COLORS.female },
            name: 'Female',
            customdata: ranked.map(r => [r.female_metric?.spearman_p, r.female_metric?.n_bins, r.biomarker_id, r.category]).reverse(),
            hovertemplate: 'Female rho=%{x:.4f}<br>p=%{customdata[0]:.5f}<br>n_bins=%{customdata[1]}<br>id=%{customdata[2]}<br>category=%{customdata[3]}<extra></extra>',
          },
          {
            type: 'bar',
            orientation: 'h',
            y,
            x: xM,
            marker: { color: COHORT_COLORS.male },
            name: 'Male',
            customdata: ranked.map(r => [r.male_metric?.spearman_p, r.male_metric?.n_bins, r.biomarker_id, r.category]).reverse(),
            hovertemplate: 'Male rho=%{x:.4f}<br>p=%{customdata[0]:.5f}<br>n_bins=%{customdata[1]}<br>id=%{customdata[2]}<br>category=%{customdata[3]}<extra></extra>',
          }
        ];
        xTitle = `Spearman rho (female vs male, Age vs ${stat})`;
      } else {
        const x = ranked.map(r => Number(r.rho)).reverse();
        const custom = ranked.map(r => {
          return [r.p, r.n_bins, r.decline_flag, r.biomarker_id, r.category];
        }).reverse();
        const colors = x.map(v => (v < 0 ? '#0f766e' : '#b45309'));
        traces = [{
          type: 'bar',
          orientation: 'h',
          y,
          x,
          marker: { color: colors },
          customdata: custom,
          hovertemplate: 'rho=%{x:.4f}<br>p=%{customdata[0]:.5f}<br>n_bins=%{customdata[1]}<br>negative_trend=%{customdata[2]}<br>id=%{customdata[3]}<br>category=%{customdata[4]}<extra></extra>',
          name: cohort === 'female' ? 'Female' : cohort === 'male' ? 'Male' : 'Pooled',
        }];
      }

      const mobile = window.matchMedia('(max-width: 760px)').matches;
      Plotly.newPlot('compare-plot', traces, {
        title: mode === 'negative' ? `Top ${topN} Most Negative Spearman Biomarkers (${stat} vs age)` :
               mode === 'positive' ? `Top ${topN} Most Positive Spearman Biomarkers (${stat} vs age)` :
               `Top ${topN} Largest |Spearman| Biomarkers (${stat} vs age)`,
        annotations: [{
          xref: 'paper',
          yref: 'paper',
          x: 1,
          y: 1.12,
          showarrow: false,
          text: `Filter: ${categoryLabel}${compareIncludeEnvEl.checked ? ' (env included)' : ''}, cohort: ${cohort}, statistic: ${stat}, outliers: ${trimLabel}`,
          font: { size: mobile ? 10 : 12, color: '#5f6b7a' },
        }],
        barmode: cohort === 'both' ? 'group' : 'relative',
        xaxis: { title: xTitle, tickfont: { size: mobile ? 10 : 12 } },
        yaxis: { automargin: true, tickfont: { size: mobile ? 10 : 12 } },
        margin: mobile ? { t: 64, l: 150, r: 10, b: 44 } : { t: 56, l: 260, r: 16, b: 54 },
        paper_bgcolor: '#ffffff',
        plot_bgcolor: '#ffffff',
      }, { responsive: true, displaylogo: false });
    }

    async function applySearch() {
      const q = searchEl.value.toLowerCase().trim();
      if (!q) return;
      const hit = getDashboardMetadata().find(
        m => `${m.display_name || ''} ${m.biomarker_name || ''} ${m.variable_name || ''} ${m.source_files || ''} ${m.source_variables || ''}`
          .toLowerCase()
          .includes(q)
      );
      if (hit) {
        selectEl.value = hit.biomarker_id;
        renderMetrics(hit.biomarker_id);
        await renderPlot(hit.biomarker_id);
      }
    }

    async function refreshDashboardFromFilters() {
      const id = renderOptions();
      renderRankTable();
      if (!id) {
        document.getElementById('metrics').innerHTML = '<div class="metric">No biomarkers match current filters.</div>';
        Plotly.newPlot('plot', [], { title: 'No biomarkers match current filters' }, { responsive: true, displaylogo: false });
        return;
      }
      renderMetrics(id);
      await renderPlot(id);
    }

    async function init() {
      const [metadata, metrics, index] = await Promise.all([
        fetchJson(`${DATA_BASE}/metadata.json`),
        fetchJson(`${DATA_BASE}/metrics.json`),
        fetchJson(`${DATA_BASE}/series_index.json`),
      ]);

      state.metadata = metadata;
      state.metrics = metrics;
      state.seriesIndex = index;
      state.metricsById = new Map(metrics.map(m => [m.biomarker_id, m]));
      state.metadataById = new Map(metadata.map(m => [m.biomarker_id, m]));

      showLowNEl.checked = true;
      includeEnvEl.checked = false;
      compareIncludeEnvEl.checked = false;
      trimSliderEl.value = '0';
      compareTrimSliderEl.value = '0';
      trimLabelEl.textContent = trimLabelFromPct(trimSliderEl.value);
      compareTrimLabelEl.textContent = trimLabelFromPct(compareTrimSliderEl.value);
      renderCategorySelect(categoryFilterEl, includeEnvEl.checked, 'all_core');
      renderCategorySelect(compareCategoryEl, compareIncludeEnvEl.checked, 'all_core');

      await refreshDashboardFromFilters();
      renderComparePlot();

      statusChip.textContent = `Ready: ${state.metadata.length} biomarkers indexed`;

      tabDashboardBtn.addEventListener('click', () => setTopTab('dashboard'));
      tabCompareBtn.addEventListener('click', () => {
        setTopTab('compare');
        renderComparePlot();
      });
      tabInfoBtn.addEventListener('click', () => setTopTab('info'));
      compareSortEl.addEventListener('change', renderComparePlot);
      compareStatEl.addEventListener('change', renderComparePlot);
      compareTopNEl.addEventListener('change', renderComparePlot);
      compareCategoryEl.addEventListener('change', renderComparePlot);
      compareCohortEl.addEventListener('change', renderComparePlot);
      compareTrimSliderEl.addEventListener('input', () => {
        const pct = normalizeTrimPct(compareTrimSliderEl.value);
        compareTrimSliderEl.value = String(pct);
        trimSliderEl.value = String(pct);
        compareTrimLabelEl.textContent = trimLabelFromPct(pct);
        trimLabelEl.textContent = trimLabelFromPct(pct);
        renderRankTable();
        if (state.currentId) renderPlot(state.currentId);
        renderComparePlot();
      });
      compareIncludeEnvEl.addEventListener('change', () => {
        renderCategorySelect(compareCategoryEl, compareIncludeEnvEl.checked, compareCategoryEl.value);
        renderComparePlot();
      });
      selectEl.addEventListener('change', async () => {
        const id = selectEl.value;
        state.currentId = id;
        renderMetrics(id);
        await renderPlot(id);
      });
      searchEl.addEventListener('change', applySearch);
      searchEl.addEventListener('keyup', (e) => { if (e.key === 'Enter') applySearch(); });
      categoryFilterEl.addEventListener('change', refreshDashboardFromFilters);
      includeEnvEl.addEventListener('change', async () => {
        renderCategorySelect(categoryFilterEl, includeEnvEl.checked, categoryFilterEl.value);
        await refreshDashboardFromFilters();
      });
      cohortFilterEl.addEventListener('change', async () => {
        compareCohortEl.value = cohortFilterEl.value;
        renderRankTable();
        renderComparePlot();
        if (state.currentId) await renderPlot(state.currentId);
      });
      trimSliderEl.addEventListener('input', async () => {
        const pct = normalizeTrimPct(trimSliderEl.value);
        trimSliderEl.value = String(pct);
        compareTrimSliderEl.value = String(pct);
        trimLabelEl.textContent = trimLabelFromPct(pct);
        compareTrimLabelEl.textContent = trimLabelFromPct(pct);
        renderRankTable();
        renderComparePlot();
        if (state.currentId) await renderPlot(state.currentId);
      });
      showLowNEl.addEventListener('change', async () => {
        if (state.currentId) await renderPlot(state.currentId);
      });
      modeCvBtn.addEventListener('click', async () => {
        setMode('cv');
        renderRankTable();
        if (state.currentId) await renderPlot(state.currentId);
      });
      modeMeanBtn.addEventListener('click', async () => {
        setMode('mean');
        renderRankTable();
        if (state.currentId) await renderPlot(state.currentId);
      });
      modeSkewBtn.addEventListener('click', async () => {
        setMode('skewness');
        renderRankTable();
        if (state.currentId) await renderPlot(state.currentId);
      });
      window.addEventListener('resize', () => {
        const plotEl = document.getElementById('plot');
        const compareEl = document.getElementById('compare-plot');
        if (plotEl) Plotly.Plots.resize(plotEl);
        if (compareEl) Plotly.Plots.resize(compareEl);
      });
    }

    init().catch(err => {
      console.error(err);
      const plot = document.getElementById('plot');
      plot.innerHTML = `<div style="padding:16px;color:#b45309;">Failed to load dashboard data. Open via local server (not file://). Error: ${err.message}</div>`;
      statusChip.textContent = 'Load failed';
    });
  </script>
</body>
</html>
